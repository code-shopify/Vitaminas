{% schema %}
{
  "name": "TikTok Slider",
  "settings": [
    {
      "type": "text",
      "id": "rating",
      "label": "Calificación (Ejemplo: 4.8)",
      "default": "4.8"
    },
    {
      "type": "text",
      "id": "reviews",
      "label": "Número de reseñas",
      "default": "1,450 reviews"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Título principal",
      "default": "Opinan de Vitatú"
    },
    {
      "type": "textarea",
      "id": "bottom_message",
      "label": "Mensaje inferior",
      "default": "*EL CONSUMO DE ESTE PRODUCTO ES RESPONSABILIDAD DE QUIÉN LO RECOMIENDA Y DE QUIÉN LO USA*"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo",
      "default": "#FEF8F0"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Color del texto",
      "default": "#333333"
    },
    {
      "type": "url",
      "id": "video_1",
      "label": "TikTok Video 1"
    },
    {
      "type": "url",
      "id": "video_2",
      "label": "TikTok Video 2"
    },
    {
      "type": "url",
      "id": "video_3",
      "label": "TikTok Video 3"
    },
    {
      "type": "url",
      "id": "video_4",
      "label": "TikTok Video 4"
    },
    {
      "type": "url",
      "id": "video_5",
      "label": "TikTok Video 5"
    },
    {
      "type": "url",
      "id": "video_6",
      "label": "TikTok Video 6"
    },
    {
      "type": "url",
      "id": "video_7",
      "label": "TikTok Video 7"
    },
    {
      "type": "url",
      "id": "video_8",
      "label": "TikTok Video 8"
    }
  ],
  "presets": [
    {
      "name": "TikTok Slider",
      "category": "Multimedia"
    }
  ]
}
{% endschema %}

<style>
  .tiktok-slider-container {
    text-align: center;
    padding: 60px 20px;
    border-radius: 10px;
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Estilos de estrellas (mantenemos los corregidos anteriormente) */
  .star-rating { display: flex; align-items: center; gap: 8px; justify-content: center; }
  .stars { display: flex; position: relative; gap: 2px; }
  .star { color: #e0e0e0; font-size: 24px; position: relative; line-height: 1; }
  .star.full { color: #ffd700; }
  .partial-star-container { position: relative; display: inline-block; width: 24px; height: 24px; }
  .partial-background { position: absolute; left: 0; color: #e0e0e0; z-index: 1; }
  .partial-fill { position: absolute; left: 0; color: #ffd700; overflow: hidden; width: 50%; z-index: 2; }

  /* Nuevos estilos para videos funcionales */
  .tiktok-embed-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 177.78%; /* Relación 16:9 para videos */
    border-radius: 12px;
    overflow: hidden;
  }

  .tiktok-embed-iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 2;
    background: rgba(0,0,0,0.3);
    transition: opacity 0.3s;
  }

  .video-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Resto de estilos se mantienen igual */
  /* ... */
</style>

<div class="tiktok-slider-container" style="background-color: {{ section.settings.background_color }}; color: {{ section.settings.text_color }};">
  <!-- Encabezado con estrellas -->
  <div class="tiktok-slider-header">
    <!-- ... (mismo código de estrellas) ... -->
  </div>

  <!-- Carrusel de videos corregido -->
  <div class="tiktok-carousel">
    <div class="tiktok-slider">
      {% for i in (1..8) %}
        {% capture video_var %}video_{{ i }}{% endcapture %}
        {% assign video_url = section.settings[video_var] %}
        {% if video_url != blank %}
          <div class="tiktok-slide">
            <div class="tiktok-embed-wrapper">
              <div class="video-overlay"></div>
              <iframe 
                class="tiktok-embed-iframe"
                src="https://www.tiktok.com/embed/v2/{{ video_url | split: '/video/' | last | split: '?' | first }}?embedType=video&autoplay=0&mute=0"
                allowfullscreen
                allow="autoplay; encrypted-media;"
                data-video-id="{{ video_url | split: '/video/' | last | split: '?' | first }}"
                loading="lazy"
              ></iframe>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Botones y mensaje inferior -->
  <!-- ... (mismo código anterior) ... -->
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const videoWrappers = document.querySelectorAll('.tiktok-embed-wrapper');
  let currentPlayingVideo = null;

  // Función para detener todos los videos
  function stopAllVideos() {
    videoWrappers.forEach(wrapper => {
      const iframe = wrapper.querySelector('iframe');
      const overlay = wrapper.querySelector('.video-overlay');
      iframe.src = iframe.src.replace('autoplay=1', 'autoplay=0');
      overlay.classList.remove('hidden');
    });
  }

  // Controlador de clic para overlays
  videoWrappers.forEach(wrapper => {
    const overlay = wrapper.querySelector('.video-overlay');
    const iframe = wrapper.querySelector('iframe');
    
    overlay.addEventListener('click', () => {
      if (currentPlayingVideo && currentPlayingVideo !== iframe) {
        stopAllVideos();
      }
      
      // Iniciar reproducción
      iframe.src = iframe.src.replace('autoplay=0', 'autoplay=1');
      overlay.classList.add('hidden');
      currentPlayingVideo = iframe;
    });
  });

  // Gestión del scroll
  window.scrollSlider = function(direction) {
    const container = document.querySelector(".tiktok-carousel");
    const slide = container.querySelector(".tiktok-slide");
    if (slide) {
      const slideWidth = slide.offsetWidth + 8;
      container.scrollBy({ left: slideWidth * direction, behavior: "smooth" });
    }
  };

  // Recargar iframes al cambiar de slide
  new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const iframe = entry.target.querySelector('iframe');
        iframe.src = iframe.src;
      }
    });
  }, { threshold: 0.5 }).observe(document.querySelector('.tiktok-carousel'));
});
</script>